---
title: トランザクション
sidebar_label: トランザクション
draft: true
toc_max_heading_level: 5
tags: [DB, トランザクション]
---

```mdx-code-block
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import FontColor from "@site/src/components/Custom/FontColor"
import SplitParagraph from "@site/src/components/Custom/SplitParagraph"
import Paragraph from "@site/src/components/Custom/Paragraph"
```

## トランザクションとは

データベースが読み書き等の処理を複数まとめて一連の情報を処理することをいう。

### ACID 特性

ACID 特性とはトランザクションが備えるべき 4 つの特性の頭文字を取ったものである。

#### 原子性 (Atomiicity)

原子性は`トランザクションは「全て実行された」状態か「全く実行されていない」状態のどちらかの状態`である。
要するに途中で処理が中断されているものは存在しないということである。(ALL or Nothing)

原子性は全ての処理が完了した場合に COMMIT し、どこか一つでも失敗すると ROLL BACK を行うことで担保することができる。

#### 一貫性 (Consistency)

一貫性は`トランザクションはデータベースの内容に矛盾を生じさせない`である。　
要するに実行前と実行後の結果に整合性があることが必要である。

#### 独立性 or 隔離性 (Isolation)

独立性(隔離性)は`トランザクションは他のトランザクションの影響を受けない(与えない)`である。
独立性にはレベルがあり、他のトランザクションに影響を与える度合いを分離レベルと呼び、
[トランザクション分離レベル](#トランザクション分離レベル)に詳細は記載している。

#### 耐久性 (Durability)

耐久性は`正常に実行されたトランザクションの結果はその後障害が発生しても保持される`である。
要するに障害発生後に回復できるようにする必要がある。

### 排他制御

一貫性と独立性を担保するために複数のトランザクションが同時に実行された場合に制御する必要がある。
この時に、複数のトラザクションを実行した場合にトランザクションを完全に独立して順番に実行した結果と同じになることを
`直列可能性`といい、この性質を満たすように制御することを`同時実行制御`という。
この同時実行制御の方法としてロックを用いてデータベースの資源を制御する方法を`排他制御`という。(ロックされた資源を排他資源という)

ロックのかけ方には 2 種類存在する。

- 共有ロック

  データを参照する時だけにかけるロックであり、他のトランザクションからもデータを参照することができる。しかし、データの更新は行えない。

- 専有ロック

  共有ロックとは異なり、他のトランザクションからデータの参照もできなくなる。他のトランザクションはロックが解放されるまで待機する。

ロックの組み合わせは以下の表になる。

|            |                   共有ロック                   |                   専有ロック                   |
| :--------: | :--------------------------------------------: | :--------------------------------------------: |
| 共有ロック |  <FontColor color="red">共存可能</FontColor>   | <FontColor color="blue">共存不可能</FontColor> |
| 専有ロック | <FontColor color="blue">共存不可能</FontColor> | <FontColor color="blue">共存不可能</FontColor> |

ロックには粒度が存在する。特定の行のみにロックをかけるのかテーブル全体にロックをかけるかといったものである。
対象の行のみロックすることを`行ロック`といい、テーブル全体をロックすることを`テーブルロック`という。

排他制御を行うことで一貫性と独立性を保つことが可能である。しかし、ロックをかけるタイミングによって`デッドロック`と呼ばれる状態に陥ることがある。

デッドロックとは 1 つのトランザクション内で 2 つ以上のデータにロックをかけるトランザクション処理が複数同時に発生した場合にお互いのトランザクションが
資源の解放待ちを行い、処理が停止してしまう現象をいう。

![デッドロック](/img/svg/Database/transaction/transaction-1.drawio.svg "デッドロック")

それぞれのトランザクションの初めの処理で A, B ともにテーブルがロックされている。
その後、トランザクション 1,2 ともに別のトランザクションがロックしているテーブルをロックしようと処理が行われると、テーブルはすでにロックされているので解放されるのを待つ。
しかし、お互いの次に必要な処理のテーブルがお互いによってロックされているのでこれ以上処理が進むことがない。

デッドロックを事前に検知する方法として待ちグラフが使用される。

待ちグラフとは実行中のトランザクションを各ノード、データのアンロック待ちの様子を矢印(有向辺)で表現したグラフである。
[平成 29 年 応用情報技術者試験 秋 午前](https://www.jitec.ipa.go.jp/1_04hanni_sukiru/mondai_kaitou_2017h29_2/2017h29a_ap_am_qs.pdf) 29 問で
待ちグラフが出題されている。

![待ちグラフ](/img/png/Database/transaction/H29-1-2-29.png "待ちグラフ")

### 楽観的ロック

### 悲観的ロック

### トランザクション分離レベル

## 参考

- [https://qiita.com/NagaokaKenichi/items/73040df85b7bd4e9ecfc](https://qiita.com/NagaokaKenichi/items/73040df85b7bd4e9ecfc)
